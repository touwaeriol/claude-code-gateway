# Claude Code Gateway 架构总结

## 系统概述

Claude Code Gateway 是一个将 Claude Code SDK 包装成 OpenAI 兼容 API 的网关服务，支持完整的工具调用流程。

## 更新历史
- 2024-01 - 优化工具调用 ID 管理，直接使用 JSON-RPC 请求 ID
- 2024-01 - 完善资源清理机制，Claude Code 会话结束时自动清理相关工具调用
- 2024-01 - 明确 MCP 协议限制：一次请求一次响应，不支持流式工具结果

## 核心组件

### 1. ToolManager（工具管理器）
- **功能**：管理客户端提供的工具定义
- **特性**：
  - 基于工具列表签名的缓存机制
  - 会话级别的工具隔离
  - 自动清理过期缓存（5分钟）
  - OpenAI 到 MCP 格式转换

### 2. ToolCallManager（工具调用管理器）
- **功能**：管理工具调用的生命周期
- **特性**：
  - 异步阻塞等待机制
  - 工具调用 ID 映射
  - 超时处理（2分钟）
  - 会话级别的调用管理

### 3. SessionManager（会话管理器）
- **功能**：管理 Claude Code 会话
- **特性**：
  - 会话创建和销毁
  - 会话上下文存储
  - 与工具权限关联

### 4. MCPAuthServer（MCP 权限服务器）
- **功能**：处理工具调用的权限验证
- **特性**：
  - 提供 approval_prompt 工具
  - 验证工具调用权限
  - JSON-RPC 协议支持
  - 独立的服务端点

### 5. MCPGatewayServer（MCP 网关服务器）
- **功能**：处理实际的工具调用
- **特性**：
  - 动态工具列表（从 ToolManager 获取）
  - 转发工具调用到 MCPGateway
  - JSON-RPC 协议支持
  - 使用请求 ID 作为工具调用 ID

### 6. MCPGateway（MCP 网关）
- **功能**：处理工具调用请求
- **特性**：
  - 权限验证
  - 工具调用阻塞等待
  - 事件驱动通知
  - 结果转发

### 7. ClaudeService（Claude 服务）
- **功能**：与 Claude Code SDK 交互
- **特性**：
  - 临时目录隔离
  - 安全提示词注入
  - 流式响应支持
  - AbortController 支持

## 数据流

### 工具调用流程

```
1. 客户端 → API Gateway
   - 发送带工具定义的请求
   - 工具在 ToolManager 中注册

2. API Gateway → Claude Code
   - 创建临时目录
   - 配置虚拟 MCP 服务器
   - 发送用户提示

3. Claude Code → 虚拟 MCP
   - 查询工具列表（从 ToolManager 获取）
   - 请求执行工具

4. 虚拟 MCP → API Gateway
   - 生成工具调用 ID
   - 发出工具调用事件
   - 阻塞等待结果

5. API Gateway → 客户端
   - 返回工具调用请求
   - 包含工具名称和参数

6. 客户端 → API Gateway
   - 执行工具
   - 发送工具结果

7. API Gateway → 虚拟 MCP
   - 解析工具调用 ID
   - 转发结果给等待的调用

8. 虚拟 MCP → Claude Code
   - 返回工具执行结果
   - Claude Code 继续处理

9. Claude Code → 客户端
   - 返回最终响应
```

## 安全特性

1. **目录隔离**：每个会话使用独立的临时目录
2. **工具权限**：只能使用客户端提供的工具
3. **MCP 限制**：只允许 mcp__auth__ 和 mcp__gateway__ 前缀
4. **会话隔离**：不同会话的工具列表完全隔离
5. **超时保护**：工具调用和会话都有超时机制

## 资源清理机制

### 自动清理触发点
1. **Claude Code 会话结束**：`finally` 块中清理所有相关工具调用
2. **客户端断开连接**：`AbortController` 触发 Claude Code 结束
3. **工具调用超时**：2分钟超时自动清理
4. **工具缓存过期**：5分钟缓存自动清理

### 清理内容
- 待处理的工具调用 Promise
- 工具调用 ID 映射关系
- 会话工具定义缓存
- 临时工作目录

## 性能优化

1. **工具缓存**：相同工具列表使用签名缓存
2. **并行处理**：支持多个会话并发
3. **流式响应**：减少延迟，提升用户体验
4. **资源清理**：自动清理过期会话和缓存

## 扩展性

系统设计支持：
- 添加新的 MCP 服务器
- 自定义工具验证逻辑
- 扩展会话管理功能
- 集成外部工具执行器